name: CI - Dockerize and Push to ECR

on:
    push:
        branches:
          - main
        tags:
          - '*'

jobs:
    build-and-push:
        runs-on: ubuntu-latest

        steps:
            # Checkout the repository
            - name: Checkout code
              uses: actions/checkout@v3

            # Configure AWS credentials using access token
            - name: Configure AWS credentials
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                AWS_REGION: eu-north-1  # Specify the AWS region
              run: |
                echo "AWS credentials and region configured"


            # Log in to Amazon ECR
            - name: Log in to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                AWS_REGION: eu-north-1  # Specify the AWS region          


            # Set up Docker image name and tag
            - name: Set up image name
              id: image-name
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                AWS_REGION: eu-north-1  # Specify the AWS region          
              run: |
                echo "IMAGE_NAME=mentee-robot" >> $GITHUB_ENV
                if [[ "${{ github.ref_type }}" == "tag" ]]; then
                  echo "IMAGE_TAG=${{ github.ref_name }}" >> $GITHUB_ENV
                else
                  echo "IMAGE_TAG=latest" >> $GITHUB_ENV
                fi
                echo "ECR_REPOSITORY=$(aws sts get-caller-identity --query Account --output text).dkr.ecr.$AWS_REGION.amazonaws.com/mentee-robot" >> $GITHUB_ENV

            # Build the Docker image
            - name: Build Docker image
              run: |
                docker build -t $ECR_REPOSITORY:$IMAGE_TAG .

            # Push the Docker image to Amazon ECR
            - name: Push Docker image to ECR
              run: |
                docker push $ECR_REPOSITORY:$IMAGE_TAG
